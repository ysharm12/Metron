import duckdb
from openai import AzureOpenAI
import re

client = AzureOpenAI(
    api_version="2024-08-01-preview",
    azure_endpoint="https://dycsb0qcdmbjek0openai.openai.azure.com/",
    api_key="61708ba3ecb24abcbf691b8126feb905"
)
# Configure OpenAI to use your Azure OpenAI resource.
# openai.api_type = "azure"
# openai.api_base = "https://<your-resource-name>.openai.azure.com/"
# openai.api_version = "2024-08-01-preview"
# openai.api_key = "YOUR_API_KEY"

# Load CSV data into DuckDB (in-memory)
csv_path = "FINAL_DATA_28JAN2025_29.csv"
con = duckdb.connect(database=':memory:')
con.execute(f"CREATE TABLE data AS SELECT * FROM read_csv_auto('{csv_path}');")

# Get the table schema to inform the LLM
schema = con.execute("DESCRIBE data").fetchdf().to_string(index=False)

# Natural language query to convert into SQL
nl_query = "LOB = OH Care, Eligibility Date > 01/01/2025, "

# Construct a prompt to instruct the model
prompt = f"""
You are a SQL generator.
Given the following table schema, from a DuckDB table named 'data':
{schema}

Write a SQL query that fulfills this request:
"{nl_query}"

Provide only the SQL query.

Make sure to use the table name 'data' in your query.
"""

# Call the Azure OpenAI API to generate the SQL query.
response = client.chat.completions.create(
                model="o1-preview",
                messages=[
                    {"role": "user", "content": prompt}
                ],
                timeout=300
            )

print(response)
raw_output = response.choices[0].message.content.strip()
print("Generated SQL Query:")
pattern = r"```sql(.*?)```"
match = re.search(pattern, raw_output, re.DOTALL)

sql_query = match.group(1).strip()
print(sql_query)

# Execute the generated SQL query using DuckDB
result = con.execute(sql_query).fetchdf()
print("Query Result:")
print(result)
