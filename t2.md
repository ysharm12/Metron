I need you to do this in streamlit as frontend and to visualize remember and make sure in prompt you say for query fired choose apropriate visualization

import duckdb
import re
import json
from openai import AzureOpenAI

def generate_sql(client, prompt, model="o1-preview"):
    """
    Generate a SQL query (or JSON output) from a natural language prompt.
    Extracts the generated text from the chat completion message.
    """
    response = client.chat.completions.create(
        model=model,
        messages=[{"role": "user", "content": prompt}],
        timeout=300
    )
    raw_output = response.choices[0].message.content.strip()
    # Try to extract text inside triple backticks if present.
    pattern = r"```(?:sql)?\s*(.*?)\s*```"
    match = re.search(pattern, raw_output, re.DOTALL)
    if match:
        return match.group(1).strip()
    else:
        return raw_output

def generate_marketing_content(client, prompt, model="o1-preview"):
    """
    Generate multi-channel marketing content from a prompt.
    """
    response = client.chat.completions.create(
        model=model,
        messages=[{"role": "user", "content": prompt}],
        timeout=300
    )
    return response.choices[0].message.content.strip()

def main():
    # Set up the Azure OpenAI client.
    client = AzureOpenAI(
        api_version="2024-08-01-preview",
        azure_endpoint="https://dycsb0qcdmbjek0openai.openai.azure.com/",
        api_key="61708ba3ecb24abcbf691b8126feb905"
    )

    # Load CSV data into DuckDB (in-memory).
    csv_path = "FINAL_DATA_28JAN2025_29.csv"
    con = duckdb.connect(database=':memory:')
    con.execute(f"CREATE TABLE data AS SELECT * FROM read_csv_auto('{csv_path}');")
    
    # Retrieve the table schema.
    schema = con.execute("DESCRIBE data").fetchdf().to_string(index=False)
    
    # Ask user for a natural language query (e.g., filter conditions).
    nl_query = input("Enter your query (e.g., filter conditions): ")

    # --- Part 1: Generate Raw Data Query ---
    prompt_raw = f"""
You are a SQL generator.
Given the following table schema from a DuckDB table named 'data':
{schema}

Write a SQL query that fulfills this request:
"{nl_query}"
Provide only the SQL query.
Make sure to use the table name 'data'.
"""
    raw_sql = generate_sql(client, prompt_raw)
    print("\nGenerated Raw SQL Query:")
    print(raw_sql)
    
    # Execute the raw data SQL query.
    try:
        raw_result = con.execute(raw_sql).fetchdf()
        print("\nRaw Data Query Result:")
        print(raw_result)
    except Exception as e:
        print("Error executing raw SQL query:", e)

    # --- Part 2: Generate Visualization Query ---
    # Instruct the model to return JSON that includes an SQL query for aggregated/visualized data.
    prompt_vis = f"""
You are a SQL generator specialized in data visualization.
Given the following table schema from a DuckDB table named 'data':
{schema}

Write a SQL query that aggregates the data to support visualization for the following request:
"{nl_query}"
Return the result in JSON format with the following keys:
- "chart_type": type of chart (e.g., "bar", "line", "pie")
- "labels": list of labels for the chart
- "aggregated_data": an SQL query that when executed returns the aggregated data.
Make sure to use the table name 'data'.
Provide only the JSON.
"""
    vis_output = generate_sql(client, prompt_vis)
    print("\nGenerated Visualization Output:")
    print(vis_output)
    try:
        vis_json = json.loads(vis_output)
        vis_sql = vis_json.get("aggregated_data", "")
        chart_type = vis_json.get("chart_type", "")
        labels = vis_json.get("labels", [])
        if vis_sql:
            vis_result = con.execute(vis_sql).fetchdf()
            print("\nVisualization Data Query Result:")
            print(vis_result)
            print("Chart Type:", chart_type)
            print("Labels:", labels)
        else:
            print("No 'aggregated_data' SQL found in the JSON.")
    except Exception as e:
        print("Error parsing visualization output as JSON:", e)
        # Fallback: treat output as plain SQL.
        try:
            vis_sql = vis_output
            vis_result = con.execute(vis_sql).fetchdf()
            print("\nVisualization Data Query Result (fallback):")
            print(vis_result)
        except Exception as e2:
            print("Error executing fallback visualization SQL query:", e2)

    # --- Part 3: Generate Multi-Channel Marketing Content ---
    generate_content = input("\nDo you want to generate multi-channel marketing content? (yes/no): ").strip().lower()
    if generate_content in ["yes", "y"]:
        business = input("Enter business name: ")
        campaign = input("Enter campaign description: ")
        channels = input("Enter preferred channels (e.g., SMS, LinkedIn, Direct Mail, Email): ")
        # Construct prompt for content generation.
        prompt_content = f"""
You are a marketing content generator.
Business: {business}
Campaign: {campaign}
Preferred Channels: {channels}
Based on the following data query: "{nl_query}"
Generate marketing content for each channel (SMS, LinkedIn, Direct Mail, Email) in JSON format.
The JSON should have keys corresponding to the channels.
Provide only the JSON output.
"""
        marketing_output = generate_marketing_content(client, prompt_content)
        print("\nGenerated Marketing Content:")
        print(marketing_output)

if __name__ == "__main__":
    main()





"""
ysharm12@LAMU0LV129CJH2P app % python app.py 
Enter your query (e.g., filter conditions): LOB = OH Care, Eligibility Date > 01/01/2025, 

Generated Raw SQL Query:
SELECT *
FROM data
WHERE lob = 'OH Care' AND Eligibility_Date > '2025-01-01';

Raw Data Query Result:
Empty DataFrame
Columns: [Member_Client_ID, DIABETES_FLAG, BP_FLAG, BH_FLAG, AVOIDABLE_ER_CLAIMS, FINANCIAL_STRESS, MAMMOGRAM, PREVENTIVE CARE, no_of_hc_1yr, no_of_hc_2yrs, no_of_hc_3yrs, In_Person, Diabetes Type 2, GERD WITHOUT ESOPHAGITIS, Hyperlipidimia, Hypertension, MSK, OTHER CHRONIC PAIN, ANALGESICS, ANTI-ULCER PREPS/GASTROINTESTINAL PREPS, ANTIASTHMATICS, ANTIBIOTICS, ANTICONVULSANTS, ANTIEMETIC/ANTIVERTIGO AGENTS, ANTIHISTAMINES, ANTIHYPERTENSIVES, ANGIOTENSIN RECEPTOR ANTAGONIST, ANTINAUSEANTS, BETA-ADRENERGIC AGENTS, INHALED, SHORT ACTING, BRONCHIAL DILATORS, CALCIUM CHANNEL BLOCKING AGENTS, CARDIOVASCULAR, CEPHALOSPORIN ANTIBIOTICS - 1ST GENERATION, CNS DRUGS, COVID-19 VACCINES, DIURETICS, ELECT/CALORIC/H2O, GASTROINTESTINAL, GLUCOCORTICOIDS, HORMONES, INFLUENZA VIRUS VACCINES, LIPOTROPICS, LOOP DIURETICS, MISCELLANEOUS, MUSCLE RELAXANTS, NASAL ANTI-INFLAMMATORY STEROIDS, NO STANDARD THERAPEUTIC CLASS CODE, NSAIDS, CYCLOOXYGENASE INHIBITOR TYPE ANALGESICS, OPIOID ANALGESIC AND NON-SALICYLATE ANALGESICS, OPIOID ANALGESICS, PENICILLIN ANTIBIOTICS, PENICILLINS, PROTON-PUMP INHIBITORS, PSYCHOTHERAPEUTIC DRUGS, SKELETAL MUSCLE RELAXANTS, THIAZIDE AND RELATED DIURETICS, TOPICAL NASAL AND OTIC PREPARATIONS, GENDER_M, AGE_GROUP_51-64, AGE_GROUP_65-74, AGE_GROUP_74+, MARITALSTS_Y, RETIRED_Y, ONLINE_ACCESS_Y, COMPUTER_OWNER_Y, EMAIL_ACCESS_Y, BANK_CARD_Y, CREDIT_ACTIVE_Y, DIGI_DEST_GRP_DESC_Weekend Parents, MINDBASE_GROUP_DESC_Devoted, MINDBASE_GROUP_DESC_Down to Earth, MINDBASE_GROUP_DESC_Rock Steady, MINDBASE_GROUP_DESC_Sophisticated, ESTIMATE_HH_INCOME_DESC_$60,000-74999, ESTIMATE_HH_INCOME_DESC_$75,000-99999, ESTIMATE_HH_INCOME_DESC_Less than $15,000, ESTIMATE_HH_INVESTABLE_ASSET_DESC_$100,000 -249.999, ESTIMATE_HH_INVESTABLE_ASSET_DESC_$250,000 -499999, ESTIMATE_HH_INVESTABLE_ASSET_DESC_Less than $5,000, cohort_RETAINED WITH HC, cohort_RETAINED WITHOUT HC, cohort_NEW MEMBER, Eligibility_Date, lob, personas]
Index: []

Generated Visualization Output:
I'm sorry, but I need more information to help with that request. Could you please specify what kind of data aggregation or visualization you would like?
Error parsing visualization output as JSON: Expecting value: line 1 column 1 (char 0)
Error executing fallback visualization SQL query: Parser Error: syntax error at or near "I"

Do you want to generate multi-channel marketing content? (yes/no): 

"""
