This is working let's try to make this better



ERROR:
"""
ysharm12@LAMU0LV129CJH2P app % python member.py
ChatCompletion(id='chatcmpl-BAbeh2jzIRextBjRwMKNrJyzebRF7', choices=[Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content='Based on the provided table schema, there are no columns related to revenue or sales. To calculate the total revenue and average sales per month, the table would need to include columns that store revenue or sales data along with a date or timestamp to group the data by month.\n\nPlease provide a table schema that includes the necessary revenue or sales columns so I can help you write the appropriate SQL query.', refusal=None, role='assistant', audio=None, function_call=None, tool_calls=None), content_filter_results={'hate': {'filtered': False, 'severity': 'safe'}, 'protected_material_code': {'filtered': False, 'detected': False}, 'protected_material_text': {'filtered': False, 'detected': False}, 'self_harm': {'filtered': False, 'severity': 'safe'}, 'sexual': {'filtered': False, 'severity': 'safe'}, 'violence': {'filtered': False, 'severity': 'safe'}})], created=1741867727, model='o1-preview-2024-09-12', object='chat.completion', service_tier=None, system_fingerprint='fp_772cb6e46d', usage=CompletionUsage(completion_tokens=602, prompt_tokens=1645, total_tokens=2247, completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=0, audio_tokens=0, reasoning_tokens=512, rejected_prediction_tokens=0), prompt_tokens_details=PromptTokensDetails(audio_tokens=0, cached_tokens=1536)), prompt_filter_results=[{'prompt_index': 0, 'content_filter_results': {'hate': {'filtered': False, 'severity': 'safe'}, 'jailbreak': {'filtered': False, 'detected': False}, 'self_harm': {'filtered': False, 'severity': 'safe'}, 'sexual': {'filtered': False, 'severity': 'safe'}, 'violence': {'filtered': False, 'severity': 'safe'}}}])
Traceback (most recent call last):
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pydantic/main.py", line 848, in __getattr__
    return pydantic_extra[item]
           ~~~~~~~~~~~~~~^^^^^^
KeyError: 'text'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ysharm12/Documents/Metron/app/member.py", line 48, in <module>
    sql_query = response.choices[0].text.strip()
                ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Library/Frameworks/Python.framework/Versions/3.12/lib/python3.12/site-packages/pydantic/main.py", line 850, in __getattr__
    raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
AttributeError: 'Choice' object has no attribute 'text'
ysharm12@LAMU0LV129CJH2P app % 
"""



This is the correct way to implement code
"""
import duckdb
from openai import AzureOpenAI

client = AzureOpenAI(
    api_version="2024-08-01-preview",
    azure_endpoint="https://dycsb0qcdmbjek0openai.openai.azure.com/",
    api_key="61708ba3ecb24abcbf691b8126feb905"
)
# Configure OpenAI to use your Azure OpenAI resource.
# openai.api_type = "azure"
# openai.api_base = "https://<your-resource-name>.openai.azure.com/"
# openai.api_version = "2024-08-01-preview"
# openai.api_key = "YOUR_API_KEY"

# Load CSV data into DuckDB (in-memory)
csv_path = "FINAL_DATA_28JAN2025_29.csv"
con = duckdb.connect(database=':memory:')
con.execute(f"CREATE TABLE data AS SELECT * FROM read_csv_auto('{csv_path}');")

# Get the table schema to inform the LLM
schema = con.execute("DESCRIBE data").fetchdf().to_string(index=False)

# Natural language query to convert into SQL
nl_query = "Calculate the total revenue and average sales per month."

# Construct a prompt to instruct the model
prompt = f"""
You are a SQL generator.
Given the following table schema:
{schema}

Write a SQL query that fulfills this request:
"{nl_query}"

Provide only the SQL query.
"""

# Call the Azure OpenAI API to generate the SQL query.
response = client.chat.completions.create(
                model="o1-preview",
                messages=[
                    {"role": "user", "content": prompt}
                ],
                timeout=300
            )

print(response)
sql_query = response.choices[0].text.strip()
print("Generated SQL Query:")
print(sql_query)

# Execute the generated SQL query using DuckDB
result = con.execute(sql_query).fetchdf()
print("Query Result:")
print(result)
"""
